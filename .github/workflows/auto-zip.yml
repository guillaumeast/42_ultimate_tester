name: Auto-zip gnl

on:
  push:
    branches:
      - master
    paths:
      - 'gnl/**'

permissions:
  contents: write

jobs:
  zip-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create gnl zip archive
        run: |
          mkdir -p zip
          zip -r "gnl.zip" "gnl/"

      - name: Commit and push updated zip to gnl branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout --orphan gnl
          git reset
          git add gnl.zip
          git commit -m "Auto-update gnl.zip from master"
          git push --force origin gnl

      - name: Commit and push updated zip to gnl branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin gnl >/dev/null 2>&1; then
            git fetch origin gnl
            git switch --detach gnl
          else
            git checkout --orphan gnl
          fi

          git reset
          git add gnl.zip
          git commit -m "Auto-update gnl.zip from master"
          git push --force origin HEAD:gnl

